# Guardian DB
- we use Guardian.DB to track JSON Web Tokens (of authorized accounts) for our REST API project. 
- Guardian.DB is a simple module that hooks into Guardian to prevent playback of tokens.
- Guardians tokens arenot tracked,, the only way to set our token inactive is to set experiation date and wait for that time to arrive.
-  Guardian.DB takes an active role and stores each token in the database, verifying it's present. The token is not valid if it's not in the database. 
- This allows to revoke any tokens generated by guardians, because any token which is not expired, has access to our protected endpoints.
- Follow along for a step-by-step tutorial to learn how to implement Guardian.DB, allowing us to track and revoke tokens in our Elixir REST API project.

# STEPS 
 1. add guardian dependenciens on mix.exs
 2. Set our configuration on the file(config.exs) to use guradian 
 DO this - config :guardian, GuardianDB,
            repo: RealDealApi.Repo,
            schema_name: "guardians_tokens", # which gurdian db is going to create 
            sweep_interval: 60 # any exipry token every 60 minutes will get removed from the database 
            the sweep will run through that table and remove expiry tokens

            - By default on token are set to 28 days unless we revoke them

3. Add command in our supervision tree, in the telemetry.ex file.
  - On the children add this --  {Guardian.DB.Token.SweeperServer, []}

4. On the guardian.ex under the create_token function 
 - You have to override three functions    
 - encode_sign, verify and on revok they are used by guardian in the background  already when we are authenticating 
 - checking guardian db doc on hex doc
 - Add the following function from the guardian db 
 ```
   def after_encode_and_sign(resource, claims, token, _options) do
    with {:ok, _} <- Guardian.DB.after_encode_and_sign(resource, claims["typ"], claims, token) do
      {:ok, token}
    end
  end

  def on_verify(claims, token, _options) do
    with {:ok, _} <- Guardian.DB.on_verify(claims, token) do
      {:ok, claims}
    end
  end

  def on_refresh({old_token, old_claims}, {new_token, new_claims}, _options) do
    with {:ok, _, _} <- Guardian.DB.on_refresh({old_token, old_claims}, {new_token, new_claims}) do
      {:ok, {old_token, old_claims}, {new_token, new_claims}}
    end
  end

  def on_revoke(claims, token, _options) do
    with {:ok, _} <- Guardian.DB.on_revoke(claims, token) do
      {:ok, claims}
    end
  end
 ```
 - Now we do the migration to create database table for guardian db 
 - Run this command mix guardian.db.gen.migration